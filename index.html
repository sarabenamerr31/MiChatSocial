<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>mi chat social GMS</title>
   
    <script src="https://www.google.com/recaptcha/api.js?render=6Lf-ju4rAAAAAH6B-ADkX-ttdN-49MX2HnolYSFU"></script>
   
    <script src="/socket.io/socket.io.js"></script>

    <style>
        /* Mucho código CSS */
    </style>
   
</head>
<body>

    <h1>Bienvenido al Chat</h1>
   
    <input type="text" id="username-input" placeholder="Elige tu nombre de usuario" required>
   
    <button onclick="verificarYUnirse()">Unirse al Chat</button>

    <input type="hidden" id="recaptcha-token" name="recaptcha_token">

    <script>
        // Inicialización de Socket.IO
        const socket = io();

        // ----------------------------------------------------------------------
        // CÓDIGO MODIFICADO: Primero verifica con reCAPTCHA, luego se une al chat
        // ----------------------------------------------------------------------

        function verificarYUnirse() {
            const username = document.getElementById('username-input').value.trim();
            if (!username) {
                alert('Por favor, ingresa un nombre de usuario.');
                return;
            }

            // 1. Ejecutar reCAPTCHA v3 para obtener el token de seguridad
            grecaptcha.ready(function() {
                // ¡REEMPLAZA TU_CLAVE_DEL_SITIO!
                grecaptcha.execute('6Lf-ju4rAAAAAH6B-ADkX-ttdN-49MX2HnolYSFU', {action: 'login'})
                .then(function(token) {
                   
                    // 2. Enviar el nombre de usuario Y el token juntos al servidor
                    socket.emit('add user', {
                        username: username,
                        token: token
                    });
                   
                    console.log('Token de seguridad enviado al servidor para verificación.');

                    // Opcional: Deshabilitar el botón para evitar doble clic
                    document.querySelector('button').disabled = true;
                });
            });
        }
       
        // Manejo de errores de inicio de sesión enviados desde el servidor (app.js)
        socket.on('login error', (msg) => {
            alert("Error de seguridad: " + msg);
            // Si hay un error, volvemos a habilitar el botón
            document.querySelector('button').disabled = false;
        });

        // Manejo del evento 'login' exitoso (si la seguridad es OK)
        socket.on('login', (data) => {
            // Aquí iría tu código para ocultar el formulario y mostrar la interfaz del chat
            console.log("Inicio de sesión exitoso. ¡Verificación de seguridad OK!");
            // alert(`Bienvenido al chat! Usuarios conectados: ${data.numUsers}`);
            // etc...
        });
       
        // ... (Tu código de manejo de mensajes, user joined, etc. iría aquí) ...

    </script>

</body>
</html>