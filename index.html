<!DOCTYPE html>
<html>
<head>
    <title>Mi Chat Social (GMS)</title>
    <script src="https://www.google.com/recaptcha/api.js?render=6Lf-ju4rAAAAAH6B-ADkX-ttdN-49MX2HnolYSFU"></script>
   
    <style>
        /* Estilos CSS (Se mantienen igual) */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        #login-area {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        #username-input {
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 80%;
            box-sizing: border-box;
        }

        #start-chat-button {
            background-color: #5cb85c;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        #start-chat-button:hover {
            background-color: #4cae4c;
        }

        .error-message {
            color: red;
            margin-top: 15px;
            display: none;
        }

        /* Estilos para el chat */
        #chat-main {
            display: flex;
            flex-direction: column;
            width: 90%;
            max-width: 900px;
            height: 90vh;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            border-bottom: 1px solid #eee;
            list-style: none;
            margin: 0;
           
        }

        #messages li {
            padding: 5px 0;
            border-bottom: 1px dotted #eee;
        }

        #form {
            display: flex;
            padding: 10px;
            border-top: 1px solid #eee;
        }

        #input-message {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 10px;
        }

        #form button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Adaptación a dispositivos móviles */
        @media (max-width: 600px) {
            #chat-main {
                width: 100%;
                height: 100vh;
                border-radius: 0;
            }
            body {
                min-height: 100vh;
            }
            #form {
                flex-direction: column;
            }
            #input-message {
                margin-bottom: 5px;
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <div id="login-area">
        <h1>¡Bienvenido/a al Chat Social!</h1>
        <p>Ingresa tu nombre para comenzar a chatear.</p>
        <input type="text" id="username-input" placeholder="Tu Nombre de Usuario">
        <button id="start-chat-button">Entrar al Chat</button>
        <div id="login-error-message" class="error-message" style="display:none;"></div>
    </div>

    <div id="chat-main">
        <ul id="messages"></ul>
        <form id="form">
            <select id="recipient-select" style="margin-right: 10px; padding: 10px; border-radius: 4px;">
                <option value="general">General</option>
            </select>
            <input id="input-message" autocomplete="off" placeholder="Escribe un mensaje o pega un enlace de YouTube..." />
            <button>Enviar</button>
        </form>
    </div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
    var socket;
    var username = '';
    // 2. Usar tu clave PÚBLICA aquí
    const RECAPTCHA_SITE_KEY = '6Lf-ju4rAAAAAH6B-ADkX-ttdN-49MX2HnolYSFU';
   
    // ===================================
    // 1. LÓGICA DE LOGIN CON RECAPTCHA V3
    // ===================================

    $('#chat-main').hide();

    $('#start-chat-button').click(function() {
        $('#login-error-message').hide();
        const inputName = $('#username-input').val().trim();
       
        if (!inputName) {
            $('#login-error-message').text("Por favor, ingresa tu nombre.").show();
            return;
        }

        // 1. Ejecutar reCAPTCHA v3 para obtener el token de seguridad
        grecaptcha.ready(function() {
            grecaptcha.execute(RECAPTCHA_SITE_KEY, {action: 'login'})
            .then(function(token) {
                username = inputName;
               
                // 2. Conectamos Socket.IO
                socket = io();
               
                // 3. Manejar conexión
                socket.on('connect', function() {
                    $('#login-area').hide();
                    $('#chat-main').show(); 
                   
                    // 4. Enviamos el nombre Y el token de reCAPTCHA para que el servidor lo verifique
                    socket.emit('add user', {
                        username: username,
                        token: token
                    });
                });
               
                setupChatEvents();
            }).catch(function(error) {
                // Manejar error si grecaptcha.execute falla
                console.error("Error al ejecutar reCAPTCHA:", error);
                $('#login-error-message').text("Error de seguridad: Recarga la página.").show();
            });
        });
    });

    // Manejo de errores de inicio de sesión enviados desde el servidor (app.js)
    // Esto se dispara si el score de reCAPTCHA es bajo o el nombre de usuario ya está tomado
    function setupChatEvents() {
        socket.on('login', function(data) {
            console.log('Login exitoso:', data.username);
            updateUserList(data.users);
           
            // Añadir mensaje de bienvenida
            $('#messages').append($('<li>').text('*** ¡Te has unido al chat! Usuarios conectados: ' + data.numUsers + ' ***'));
        });

        socket.on('user joined', function(data) {
            $('#messages').append($('<li>').text('*** ' + data.username + ' se ha unido al chat. Usuarios conectados: ' + data.numUsers + ' ***'));
            updateUserList(data.users);
        });

        socket.on('user left', function(data) {
            $('#messages').append($('<li>').text('*** ' + data.username + ' ha abandonado el chat. Usuarios conectados: ' + data.numUsers + ' ***'));
            updateUserList(data.users);
        });

        socket.on('chat message', function(msg) {
            if (msg.error) {
                $('#messages').append($('<li>').text('*** Error: ' + msg.error + ' ***').css('color', 'red'));
                return;
            }
            // Si es un objeto, es un mensaje de YouTube
            if (typeof msg === 'object' && msg.videoId) {
                const youtubeLink = 'https://www.youtube.com/watch?v=' + msg.videoId;
                const li = $('<li>').html(`[${msg.sender} compartió un video] <a href="${youtubeLink}" target="_blank">${youtubeLink}</a>`);
                $('#messages').append(li);
            } else {
                $('#messages').append($('<li>').text(msg));
            }
        });

        socket.on('private message', function(data) {
            // Mensajes privados en color diferente
            $('#messages').append($('<li>').text(data.msg).css('color', 'purple'));
        });

        socket.on('login error', (msg) => {
            $('#login-error-message').text(msg).show();
            // Desconectar el socket para que el usuario pueda intentarlo de nuevo
            if (socket) {
                 socket.disconnect();
            }
            $('#chat-main').hide();
            $('#login-area').show();
        });

        $('#form').submit(function(e) {
            e.preventDefault();
            const msg = $('#input-message').val();
            const recipient = $('#recipient-select').val();
           
            if (msg) {
                // Verificar si es un enlace de YouTube
                const youtubeRegex = /youtu\.be\/([a-zA-Z0-9_-]{11})|youtube\.com\/watch\?v=([a-zA-Z0-9_-]{11})/;
                const match = msg.match(youtubeRegex);

                if (match) {
                    const videoId = match[1] || match[2];
                    socket.emit('chat message', { msg: 'YouTubeShare', videoId: videoId });
                } else {
                    socket.emit('chat message', { msg: msg, recipient: recipient });
                }
               
                $('#input-message').val('');
            }
        });
    }

    function updateUserList(users) {
        const currentRecipient = $('#recipient-select').val();
        $('#recipient-select').empty();
        $('#recipient-select').append($('<option>').val('general').text('General'));
       
        users.forEach(function(user) {
            if (user !== username) { // No listarse a sí mismo
                $('#recipient-select').append($('<option>').val(user).text('DM: ' + user));
            }
        });
        // Restaurar la selección si el usuario sigue en la lista
        if (users.includes(currentRecipient) || currentRecipient === 'general') {
             $('#recipient-select').val(currentRecipient);
        }
    }
</script>

</body>
</html>