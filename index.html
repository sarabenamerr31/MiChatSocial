<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Chat Social</title>
    <style>
        /* Estilos CSS simplificados para el chat */
        body { margin: 0; padding: 0; background-color: #2c3e50; font-family: Arial, sans-serif; color: #ecf0f1; display: flex; height: 100vh; }
        #chat-container { display: flex; flex-grow: 1; }
        #user-list { width: 150px; background: #34495e; padding: 10px; overflow-y: auto; }
        #user-list h3 { margin-top: 0; color: #e74c3c; }
        #user-list ul { list-style: none; padding: 0; }
        #user-list li { padding: 5px 0; border-bottom: 1px solid #4a627a; cursor: pointer; }
        #main-chat { flex-grow: 1; display: flex; flex-direction: column; background: #2c3e50; }
        #messages { list-style-type: none; margin: 0; padding: 10px; flex-grow: 1; overflow-y: auto; background: #34495e; }
        #messages li { padding: 5px 10px; border-bottom: 1px solid #2c3e50; }
        .dm-message { color: #f1c40f; font-style: italic; }
        .system-message { color: #95a5a6; text-align: center; }
        .chat-form { padding: 10px; background: #2c3e50; display: flex; border-top: 1px solid #34495e; }
        .chat-form input { flex-grow: 1; padding: 10px; border: none; border-radius: 4px 0 0 4px; background: #ecf0f1; color: #2c3e50; }
        .chat-form button { padding: 10px; background: #1abc9c; border: none; color: white; border-radius: 0 4px 4px 0; cursor: pointer; }
        .chat-form button:hover { background: #16a085; }
       
        /* Estilos de Login */
        #login-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #2c3e50; display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 1000; }
        #login-box { background: #34495e; padding: 30px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5); text-align: center; }
        #login-box input { padding: 10px; margin-bottom: 15px; width: 250px; border: 1px solid #2c3e50; border-radius: 4px; }
        #login-box button { background: #3498db; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        #login-box button:hover { background: #2980b9; }

        /* Media Queries para Responsividad M√≥vil */
        @media (max-width: 600px) {
            #chat-container { flex-direction: column; }
            #user-list { width: 100%; height: 100px; order: 2; border-bottom: none; }
            #user-list h3 { display: none; }
            #user-list ul { display: flex; overflow-x: auto; white-space: nowrap; }
            #user-list li { padding: 5px 10px; margin-right: 10px; border-bottom: none; }
            #main-chat { order: 1; }
        }
    </style>
    <script src="https://www.google.com/recaptcha/api.js?render=TU_CLAVE_DEL_SITIO_PUBLICA"></script>
</head>
<body>
   
    <div id="login-screen">
        <div id="login-box">
            <h2>Bienvenido al Chat</h2>
            <input id="username" autocomplete="off" placeholder="Introduce tu nombre de usuario" />
            <button onclick="verificarYUnirse()">Entrar al Chat</button>
        </div>
    </div>

    <div id="chat-container" style="display: none;">
        <div id="user-list">
            <h3>Usuarios Conectados (<span id="user-count">0</span>)</h3>
            <ul id="users"></ul>
        </div>

        <div id="main-chat">
            <ul id="messages"></ul>
            <form class="chat-form" onsubmit="sendMessage(event)">
                <button type="button" onclick="showFileOptions()">üñºÔ∏è Archivo</button>
                <input id="m" autocomplete="off" placeholder="Escribe un mensaje..." />
                <button>Enviar</button>
            </form>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentUsername = '';
        let recipient = 'general'; // Por defecto a chat general
       
        // Funci√≥n para cambiar el destinatario (DM)
        function changeRecipient(newRecipient) {
            recipient = newRecipient;
            // Indicaci√≥n visual del destinatario actual
            document.getElementById('m').placeholder = (newRecipient === 'general')
                ? 'Escribe un mensaje...'
                : `(DM para ${newRecipient}):`;
        }

        // 2. CORRECCI√ìN DE NOMBRE EN LISTA DE USUARIOS
        function updateUsers(users) {
            const userList = document.getElementById('users');
            userList.innerHTML = '';
           
            // A√±adir la opci√≥n de chat general
            const generalLi = document.createElement('li');
            generalLi.textContent = 'Chat General';
            generalLi.style.fontWeight = (recipient === 'general') ? 'bold' : 'normal';
            generalLi.onclick = () => changeRecipient('general');
            userList.appendChild(generalLi);
           
            // A√±adir los usuarios conectados
            users.forEach(user => {
                // Omitir tu propio nombre
                if (user !== currentUsername) {
                    const li = document.createElement('li');
                    li.textContent = user;
                    li.style.fontWeight = (recipient === user) ? 'bold' : 'normal';
                    li.onclick = () => changeRecipient(user);
                    userList.appendChild(li);
                }
            });
            document.getElementById('user-count').textContent = users.length;
        }

        // L√ìGICA DE LOGIN Y SEGURIDAD RECAPTCHA
        function verificarYUnirse() {
            const usernameInput = document.getElementById('username').value.trim();
            if (!usernameInput) {
                alert('Por favor, introduce un nombre de usuario.');
                return;
            }

            // Aqu√≠ se ejecuta la verificaci√≥n de reCAPTCHA
            grecaptcha.ready(function() {
                grecaptcha.execute('TU_CLAVE_DEL_SITIO_PUBLICA', {action: 'login'}).then(function(token) {
                    currentUsername = usernameInput;
                    socket.emit('add user', { username: currentUsername, token: token });
                });
            });
        }
       
        // 3. C√ìDIGO PARA ENV√çO DE FOTOS/ARCHIVOS (Mejora: funci√≥n integrada de archivo)
        function showFileOptions() {
            // Esto solo es una simulaci√≥n de env√≠o, la implementaci√≥n completa requiere m√°s c√≥digo del lado del servidor.
            // Para mantener la simplicidad, mostraremos la notificaci√≥n de env√≠o.
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.onchange = function(e) {
                const fileName = e.target.files[0].name;
                const confirmSend = confirm(`¬øQuieres notificar que has enviado el archivo: ${fileName}?`);
                if (confirmSend) {
                    // Env√≠a un mensaje especial al servidor
                    socket.emit('chat message', { msg: `üì§ ha compartido un archivo: ${fileName}.`, recipient: recipient });
                }
            };
            fileInput.click();
        }

        // L√ìGICA DE MENSAJES Y EVENTOS
        function sendMessage(e) {
            e.preventDefault();
            const input = document.getElementById('m');
            const msg = input.value.trim();
            if (msg) {
                socket.emit('chat message', { msg: msg, recipient: recipient });
                input.value = '';
            }
        }

        socket.on('login', function(data) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('chat-container').style.display = 'flex';
            updateUsers(data.users);
        });

        socket.on('user joined', function(data) {
            const item = document.createElement('li');
            item.className = 'system-message';
            item.textContent = data.username + ' se ha unido al chat.';
            document.getElementById('messages').appendChild(item);
            updateUsers(data.users);
            window.scrollTo(0, document.body.scrollHeight);
        });

        socket.on('user left', function(data) {
            const item = document.createElement('li');
            item.className = 'system-message';
            item.textContent = data.username + ' ha abandonado el chat.';
            document.getElementById('messages').appendChild(item);
            updateUsers(data.users);
            window.scrollTo(0, document.body.scrollHeight);
        });

        socket.on('chat message', function(msg) {
            const item = document.createElement('li');
            item.textContent = msg;
            document.getElementById('messages').appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        });
       
        socket.on('private message', function(data) {
            const item = document.createElement('li');
            item.className = 'dm-message';
            item.textContent = data.msg;
            document.getElementById('messages').appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        });

        socket.on('login error', function(msg) {
            alert('Error al intentar unirse: ' + msg);
        });
       
        // Aseg√∫rate de reemplazar "TU_CLAVE_DEL_SITIO_PUBLICA" con tu clave de reCAPTCHA
        // Esto debe ir despu√©s de que todo el DOM est√© cargado.
        document.addEventListener('DOMContentLoaded', (event) => {
            const script = document.querySelector('script[src*="recaptcha"]');
            if (script) {
                const public_key = script.src.split('render=')[1];
                document.getElementById('login-box').querySelector('button').onclick = function() {
                    const usernameInput = document.getElementById('username').value.trim();
                    if (!usernameInput) {
                        alert('Por favor, introduce un nombre de usuario.');
                        return;
                    }

                    grecaptcha.ready(function() {
                        grecaptcha.execute(public_key, {action: 'login'}).then(function(token) {
                            currentUsername = usernameInput;
                            socket.emit('add user', { username: currentUsername, token: token });
                        });
                    });
                };
            }
        });

    </script>
</body>
</html>